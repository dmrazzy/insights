import marimo

__generated_with = "0.15.3"
app = marimo.App(width="full")


@app.cell
def setup_pyoso():
    # This code sets up pyoso to be used as a database provider for this notebook
    # This code is autogenerated. Modification could lead to unexpected results :)
    import marimo as mo
    from pyoso import Client
    client = Client()
    try:
        pyoso_db_conn = client.dbapi_connection()    
    except Exception as e:
        pyoso_db_conn = None
    return client, mo


@app.cell
def about_app(mo):
    mo.vstack([
        mo.md("""
        # OSO Coverage Dashboard
        <small>Author: <span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">OSO Team</span> Â· Last Updated: <span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">2025-09-15</span></small>
        """),
        mo.md("""
        OSO maintains a large repository of open source projects called oss-directory. It's more than just an awesome list ... it's the starting point of the OSO data pipeline. We run indexers on every artifact linked to projects in the directory to produce metrics for our API and dashboards. We also use other project registries -- OP Atlas, Crypto Ecosystems, DefiLlama, OpenLabelsInitiative. This dashboard provides an overview of all the labeling we and our partners have done!

        """),
        mo.accordion({
            "<b>Click to see details on how app was made</b>": mo.accordion({
                "Methodology": """
                - Artifacts are categorized by source type (OSO, Software, Packages, Data Aggregators, Websites, Superchain, Other Blockchains)
                - Project counts and artifact counts are aggregated by source
                - Data is organized in a pivot table format for easy comparison
                - Coverage metrics show the breadth of OSO's data collection across different ecosystems
                ![img](https://docs.opensource.observer/assets/images/project-directory-7f628a5f09a6983c43ea4da6750b8b67.png)
                """,
                "Data Sources": """
                - [OSO Directory](https://github.com/opensource-observer/oss-directory) - Primary project registry
                - [OP Atlas](https://atlas.optimism.io/) - Optimism ecosystem projects
                - [Crypto Ecosystems](https://cryptoecosystems.com/) - Blockchain project registry
                - [DefiLlama](https://defillama.com/) - DeFi protocol data
                - [OpenLabelsInitiative](https://openlabels.org/) - Project labeling standards
                - Various package registries (NPM, PyPI, Go, NuGet, Rust, Gem)
                """,
                "Further Resources": """
                - [Getting Started with Pyoso](https://docs.opensource.observer/docs/get-started/python)
                - [Using the Semantic Layer](https://docs.opensource.observer/docs/get-started/using-semantic-layer)
                - [Marimo Documentation](https://docs.marimo.io/)
                """
            })
        })    
    ])
    return


@app.cell
def get_data(client):
    _query = f"""
    WITH artifacts AS (
        SELECT 
            project_source,
            artifact_source,
            APPROX_DISTINCT(project_id) AS num_projects,
            APPROX_DISTINCT(artifact_id) AS num_artifacts
        FROM artifacts_by_project_v1
        GROUP BY 1,2
    )
    SELECT
        artifact_source,
        CASE
            WHEN artifact_source = 'OSS_DIRECTORY' THEN '0. OSO'
            WHEN artifact_source = 'GITHUB' THEN '1. Software'
            WHEN artifact_source IN ('NPM', 'GO', 'PIP', 'NUGET', 'RUST', 'GEM') THEN '2. Packages'
            WHEN artifact_source IN ('DEFILLAMA') THEN '3. Data Aggregators'
            WHEN artifact_source IN ('WWW', 'TWITTER', 'FARCASTER') THEN '4. Websites'	
            WHEN chains.chain IS NOT NULL THEN '5. Superchain'
            ELSE '6. Other Blockchains'
        END AS artifact_source_type,
        project_source,
        num_projects,
        num_artifacts
    FROM artifacts
    LEFT JOIN int_superchain_chain_names AS chains
        ON artifacts.artifact_source = chains.chain
    ORDER BY 2,1,3
    """

    df = client.to_pandas(_query)
    return (df,)


@app.cell
def generate_stats(df, mo):
    total_projects = df['num_projects'].sum()
    total_artifacts = df['num_artifacts'].sum()
    unique_sources = df['artifact_source'].nunique()
    unique_project_sources = df['project_source'].nunique()

    total_projects_stat = mo.stat(
        label="Total Projects",
        bordered=True,
        value=f"{total_projects:,.0f}",
    )

    total_artifacts_stat = mo.stat(
        label="Total Artifacts",
        bordered=True,
        value=f"{total_artifacts:,.0f}",
    )

    unique_sources_stat = mo.stat(
        label="Artifact Sources",
        bordered=True,
        value=f"{unique_sources:,.0f}",
    )

    unique_project_sources_stat = mo.stat(
        label="Project Sources",
        bordered=True,
        value=f"{unique_project_sources:,.0f}",
    )

    mo.hstack(
        [total_projects_stat, total_artifacts_stat, unique_sources_stat, unique_project_sources_stat],
        widths="equal",
        gap=1,
    )
    return


@app.cell
def generate_table(df, mo):
    col_order = list(df.groupby('project_source')['num_artifacts'].sum().sort_values(ascending=False).index)
    col_format = {c:'{:,.0f}' for c in col_order}

    pivot_table = df.pivot_table(
        columns='project_source',
        index=['artifact_source_type', 'artifact_source'],
        values='num_artifacts',
        fill_value=0
    )[col_order]

    mo.ui.table(
        pivot_table,
        show_data_types=False,
        show_column_summaries=False,
        page_size=100,
        format_mapping=col_format
    )
    return


if __name__ == "__main__":
    app.run()
